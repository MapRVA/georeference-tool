{% extends 'base.html' %}

{% block title %}{% if image.title %}{{ image.title }}{% else %}Image #{{ image.id }}{% endif %} - Georeference Tool{% endblock %}

{% block extra_css %}
<!-- MapLibre GL JS CSS -->
<link href="https://unpkg.com/maplibre-gl@5.7.1/dist/maplibre-gl.css" rel="stylesheet" />
<link href='https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/photoswipe.css' rel='stylesheet' />

<style>
    .breadcrumb {
        background: none;
        padding: 0;
    }

    .image-container {
        overflow: hidden;
    }

    .image-container img {
        transition: transform 0.2s ease;
        cursor: pointer;
    }

    .image-container img:hover {
        transform: scale(1.02);
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .status-badge {
        font-size: 0.85em;
        padding: 0.5em 0.75em;
    }

    .map-container {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }

    #image-detail-map {
        width: 100%;
        height: 300px;
        border-radius: 0.375rem;
    }

    .maplibregl-popup-content {
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .coordinate-display {
        font-family: monospace;
        font-size: 0.9em;
        background-color: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        display: inline-block;
    }

    .action-button {
        transition: all 0.2s ease;
    }

    .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Timeline Styles */
    .timeline {
        position: relative;
        padding-left: 1.5em;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 0.5em;
        padding-bottom: 0.5em;
    }

    /* Vertical line between timeline icons */
    .timeline-item:not(:last-child)::after {
        content: '';
        position: absolute;
        left: -1.1em;
        top: 1em;
        width: 0.2em;
        height: calc(100% + 10px);
        background-color: #dee2e6;
    }

    .timeline-marker {
        position: absolute;
        left: -1.5em;
        top: 1em;
        width: 1em;
        height: 1em;
        background-color: #fff;
        border: 0.2em solid #dee2e6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .timeline-marker i {
        color: #333;
    }

    .timeline-marker.active {
        border-color: #dc3545;
        box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
    }

    .active-badge {
        position: absolute;
        top: -8px;
        right: -45px;
        background-color: #dc3545;
        color: #fff;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        white-space: nowrap;
        font-weight: 500;
    }

    .timeline-content {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-left: 10px;
        position: relative;
    }

    .timeline-details .badge {
        font-size: 0.75em;
    }

    .timeline-notes {
        margin-top: 10px;
        padding: 8px 12px;
        background-color: #e9ecef;
        border-radius: 6px;
    }

    .timeline-validations {
        border-top: 1px solid #e9ecef;
        padding-top: 12px;
    }

    .validation-item {
        padding: 8px 12px;
        background-color: #fff;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .validation-icon {
        width: 0.75em;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 0.25em;
    }

    .validation-user .badge {
        font-size: 0.7em;
    }

    .validation-notes {
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'images:browse_sources' %}">Sources</a></li>
                <li class="breadcrumb-item"><a href="{{ image.collection.source.get_absolute_url }}">{{ image.collection.source.name }}</a></li>
                <li class="breadcrumb-item"><a href="{{ image.collection.get_absolute_url }}">{{ image.collection.name }}</a></li>
                <li class="breadcrumb-item active">
                    {% if image.title %}{{ image.title|truncatechars:50 }}{% else %}Image #{{ image.id }}{% endif %}
                </li>
            </ol>
        </nav>

        <div class="row">
            <!-- Image Display -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            {% if image.title %}
                                {{ image.title }}
                            {% else %}
                                Image #{{ image.id }}
                            {% endif %}
                        </h5>
                        <div class="d-flex gap-2 flex-wrap">
                            {% if image.difficulty %}
                                <span class="badge status-badge
                                    {% if image.difficulty == 'easy' %}bg-success
                                    {% elif image.difficulty == 'medium' %}bg-warning text-dark
                                    {% else %}bg-danger{% endif %}">
                                    <i class="fas fa-signal me-1"></i>{{ image.difficulty|capfirst }}
                                </span>
                            {% endif %}

                            <span class="badge status-badge {% if image.is_georeferenced %}bg-success{% elif image.will_not_georef %}bg-secondary{% else %}bg-warning text-dark{% endif %}">
                                {% if image.is_georeferenced %}
                                    <i class="fas fa-map-marker-alt me-1"></i>Georeferenced
                                {% elif image.will_not_georef %}
                                    <i class="fas fa-ban me-1"></i>Will Not Georeference
                                {% else %}
                                    <i class="fas fa-clock me-1"></i>Pending
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="image-container position-relative" style="min-height: 400px;">
                            <div class="pswp-gallery" id="pswp-gallery">
                                <a href="{{ image.permalink }}" title="Click to view full-size image">
                                    <img id="main-image" src="{{ image.permalink }}"
                                         alt="{% if image.title %}{{ image.title }}{% else %}Image #{{ image.id }}{% endif %}"
                                         class="img-fluid w-100"
                                         style="object-fit: contain; background-color: #f8f9fa; max-height: 600px; display: block; cursor: zoom-in;"
                                         title="Click to view full-size image">
                                </a>
                            </div>

                            <!-- Fallback for broken images -->
                            <div id="image-fallback" class="bg-light align-items-center justify-content-center position-absolute w-100 h-100" style="top: 0; left: 0; min-height: 400px; display: none; z-index: 1;">
                                <div class="text-center">
                                    <i class="fas fa-image fa-4x text-muted mb-3"></i>
                                    <p class="text-muted mb-3">Image could not be loaded</p>
                                    <a href="{{ image.original_url }}" target="_blank" class="btn btn-outline-primary">
                                        <i class="fas fa-external-link-alt me-1"></i>View Original Image
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map Display (if georeferenced) -->
                {% if image.is_georeferenced %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-map me-2"></i>Current Georeference</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="map-container">
                            <div id="image-detail-map"></div>
                        </div>
                    </div>
                    <div class="card-footer bg-light">
                        <div class="row g-2 text-center">
                            <div class="col-md-4">
                                <small class="text-muted d-block">Coordinates</small>
                                <span class="coordinate-display">{{ image.get_georeference.latitude|floatformat:6 }}, {{ image.get_georeference.longitude|floatformat:6 }}</span>
                            </div>
                            {% if image.get_georeference.direction is not None %}
                            <div class="col-md-4">
                                <small class="text-muted d-block">Direction</small>
                                <span class="coordinate-display">
                                    {{ image.get_georeference.direction }}°
                                    {% if image.get_georeference.direction == 0 %} (N)
                                    {% elif image.get_georeference.direction == 90 %} (E)
                                    {% elif image.get_georeference.direction == 180 %} (S)
                                    {% elif image.get_georeference.direction == 270 %} (W)
                                    {% elif image.get_georeference.direction >= 315 or image.get_georeference.direction < 45 %} (N)
                                    {% elif image.get_georeference.direction >= 45 and image.get_georeference.direction < 135 %} (E)
                                    {% elif image.get_georeference.direction >= 135 and image.get_georeference.direction < 225 %} (S)
                                    {% elif image.get_georeference.direction >= 225 and image.get_georeference.direction < 315 %} (W)
                                    {% endif %}
                                </span>
                            </div>
                            {% endif %}
                            <div class="col-md-4">
                                <small class="text-muted d-block">Map Tools</small>
                                <a href="https://mapswap.trailsta.sh/swap/#type=l&url=https%3A%2F%2Fwww.openstreetmap.org%2F%23map%3D18%2F{{ image.get_georeference.latitude }}%2F{{ image.get_georeference.longitude }}"
                                   target="_blank" class="btn btn-outline-primary btn-sm">
                                    MapSwap
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar with Information and Actions -->
            <div class="col-lg-4">
                <!-- Image Metadata -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Image Details</h6>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-5">Source:</dt>
                            <dd class="col-sm-7">
                                <a href="{{ image.collection.source.get_absolute_url }}" class="text-decoration-none">
                                    {{ image.collection.source.name }}
                                </a>
                            </dd>

                            <dt class="col-sm-5">Collection:</dt>
                            <dd class="col-sm-7">
                                <a href="{{ image.collection.get_absolute_url }}" class="text-decoration-none">
                                    {{ image.collection.name }}
                                </a>
                            </dd>

                            {% if image.date_display != "Unknown date" %}
                                <dt class="col-sm-5">Date:</dt>
                                <dd class="col-sm-7">{{ image.date_display }}</dd>
                            {% endif %}

                            {% if image.description %}
                                <dt class="col-sm-5">Description:</dt>
                                <dd class="col-sm-7">{{ image.description|truncatewords:20 }}</dd>
                            {% endif %}

                            {% if image.skip_count > 0 %}
                                <dt class="col-sm-5">Skip Count:</dt>
                                <dd class="col-sm-7">
                                    <span class="badge bg-warning text-dark">{{ image.skip_count }}</span>
                                </dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>

                <!-- Georeference Information -->
                {% if image.is_georeferenced %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Georeference Details</h6>
                        </div>
                        <div class="card-body">
                            <dl class="row">
                                <dt class="col-sm-5">By:</dt>
                                <dd class="col-sm-7">
                                    <i class="fas fa-user me-1"></i>
                                    {% if image.get_georeference.georeferenced_by %}
                                        {% if image.get_georeference.georeferenced_by.get_profile_url %}
                                            <a href="{{ image.get_georeference.georeferenced_by.get_profile_url }}" target="_blank" class="text-decoration-none">
                                                {{ image.get_georeference.georeferenced_by.get_display_name }}
                                                <i class="fas fa-external-link-alt ms-1 small text-muted"></i>
                                            </a>
                                        {% else %}
                                            {{ image.get_georeference.georeferenced_by.get_display_name }}
                                        {% endif %}
                                    {% else %}
                                        Anonymous
                                    {% endif %}
                                </dd>

                                <dt class="col-sm-5">Date:</dt>
                                <dd class="col-sm-7">
                                    <i class="fas fa-calendar me-1"></i>{{ image.get_georeference.georeferenced_at|date:"M j, Y" }}
                                </dd>

                                <dt class="col-sm-5">Total:</dt>
                                <dd class="col-sm-7">
                                    <span class="badge bg-info">
                                        {{ image.georeference_count }} submission{{ image.georeference_count|pluralize }}
                                    </span>
                                </dd>

                                <dt class="col-sm-5">Confidence:</dt>
                                <dd class="col-sm-7">
                                    <span class="badge {% if image.get_georeference.confidence == 'high' %}bg-success{% elif image.get_georeference.confidence == 'medium' %}bg-warning text-dark{% elif image.get_georeference.confidence == 'low' %}bg-danger{% else %}bg-secondary{% endif %}">
                                        {{ image.get_georeference.confidence|capfirst }}
                                    </span>
                                </dd>

                                <dt class="col-sm-5">Validations:</dt>
                                <dd class="col-sm-7">
                                    <span class="badge {% if image.get_georeference.validation_count > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ image.get_georeference.validation_count }}
                                    </span>
                                </dd>

                                {% if image.get_georeference.confidence_notes %}
                                    <dt class="col-sm-12 mt-2">Notes:</dt>
                                    <dd class="col-sm-12">
                                        <div class="bg-light p-2 rounded">
                                            <small>{{ image.get_georeference.confidence_notes }}</small>
                                        </div>
                                    </dd>
                                {% endif %}
                            </dl>
                        </div>
                    </div>
                {% endif %}

                <!-- Actions -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-cog me-2"></i>Actions</h6>
                    </div>
                    <div class="card-body">
                        {% if not image.is_georeferenced and not image.will_not_georef %}
                            <a href="{% url 'images:georeference_interface' %}?image={{ image.id }}"
                               class="btn btn-success w-100 mb-3 action-button">
                                <i class="fas fa-map-marker-alt me-2"></i>Georeference This Image
                            </a>
                        {% elif image.is_georeferenced %}
                            {% if request.user.is_authenticated %}
                                {% if image.get_georeference.georeferenced_by and request.user == image.get_georeference.georeferenced_by %}
                                    <div class="alert alert-success mb-3">
                                        <i class="fas fa-user-check me-2"></i>
                                        You submitted the current georeference.
                                    </div>
                                {% else %}
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        This image has been georeferenced.
                                    </div>
                                    <button class="btn btn-primary w-100 mb-3 action-button" data-bs-toggle="modal" data-bs-target="#validateModal">
                                        <i class="fas fa-check-circle me-2"></i>Validate This Georeference
                                    </button>
                                {% endif %}

                                <a href="{% url 'images:georeference_interface' %}?image={{ image.id }}"
                                   class="btn btn-warning w-100 mb-3 action-button">
                                    <i class="fas fa-edit me-2"></i>Submit a Correction
                                </a>
                            {% else %}
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    This image has been georeferenced.
                                </div>
                            {% endif %}
                        {% endif %}

                        <!-- Navigation buttons -->
                        <div class="btn-group w-100 mb-3" role="group">
                            <a href="{{ image.collection.get_absolute_url }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Collection
                            </a>
                            <a href="{% url 'images:random_image' %}" class="btn btn-outline-primary">
                                <i class="fas fa-random me-1"></i>Random
                            </a>
                        </div>

                        <!-- External links -->
                        <div class="d-grid">
                            <a href="{{ image.original_url }}" target="_blank" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-external-link-alt me-1"></i>View Original Source
                            </a>
                        </div>

                        <!-- Admin controls -->
                        {% if user.is_staff %}
                            <hr>
                            <h6 class="text-muted small">Admin Controls</h6>

                            <!-- Difficulty marking buttons -->
                            {% if image.difficulty %}
                                <div class="mb-2">
                                    <small class="text-muted d-block mb-1">Difficulty Level:</small>
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-sm {% if image.difficulty == 'easy' %}btn-success{% else %}btn-outline-success mark-difficulty{% endif %}"
                                                {% if image.difficulty == 'easy' %}disabled{% else %}data-difficulty="easy"{% endif %}>
                                            Easy
                                        </button>
                                        <button type="button" class="btn btn-sm {% if image.difficulty == 'medium' %}btn-warning{% else %}btn-outline-warning mark-difficulty{% endif %}"
                                                {% if image.difficulty == 'medium' %}disabled{% else %}data-difficulty="medium"{% endif %}>
                                            Medium
                                        </button>
                                        <button type="button" class="btn btn-sm {% if image.difficulty == 'hard' %}btn-danger{% else %}btn-outline-danger mark-difficulty{% endif %}"
                                                {% if image.difficulty == 'hard' %}disabled{% else %}data-difficulty="hard"{% endif %}>
                                            Hard
                                        </button>
                                    </div>
                                </div>
                            {% else %}
                                <div class="mb-2">
                                    <small class="text-muted d-block mb-1">Mark Difficulty:</small>
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-success btn-sm mark-difficulty" data-difficulty="easy">Easy</button>
                                        <button type="button" class="btn btn-outline-warning btn-sm mark-difficulty" data-difficulty="medium">Medium</button>
                                        <button type="button" class="btn btn-outline-danger btn-sm mark-difficulty" data-difficulty="hard">Hard</button>
                                    </div>
                                </div>
                            {% endif %}

                            <a href="/admin/images/image/{{ image.id }}/change/" class="btn btn-outline-secondary btn-sm w-100">
                                <i class="fas fa-edit me-1"></i>Edit in Admin
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeline Section -->
        {% if image.georeferences.exists %}
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>Timeline</h5>
                        <small class="text-muted">All georeferencing activity for this image</small>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for georeference in image.georeferences.all %}
                                <div class="timeline-item">
                                    <div class="timeline-marker">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <h6 class="timeline-title">
                                                Georeferenced by
                                                {% if georeference.georeferenced_by %}
                                                    {% if georeference.georeferenced_by.get_profile_url %}
                                                        <strong>
                                                            <a href="{{ georeference.georeferenced_by.get_profile_url }}" target="_blank" class="text-decoration-none text-dark">
                                                                {{ georeference.georeferenced_by.get_display_name }}
                                                                <i class="fas fa-external-link-alt ms-1 small text-muted"></i>
                                                            </a>
                                                        </strong>
                                                    {% else %}
                                                        <strong>{{ georeference.georeferenced_by.get_display_name }}</strong>
                                                    {% endif %}
                                                {% else %}
                                                    <strong>Anonymous</strong>
                                                {% endif %}
                                                {% if forloop.last %}
                                                    <span class="badge bg-success ms-2">Current</span>
                                                {% endif %}
                                            </h6>
                                            <small class="text-muted">
                                                <i class="fas fa-calendar me-1"></i>{{ georeference.georeferenced_at|date:"M j, Y g:i A" }}
                                            </small>
                                        </div>
                                        <div class="timeline-details">
                                            <div class="row g-2 mb-2">
                                                <div class="col-auto">
                                                    <span class="badge bg-light text-dark">
                                                        <i class="fas fa-crosshairs me-1"></i>
                                                        {{ georeference.latitude|floatformat:6 }}, {{ georeference.longitude|floatformat:6 }}
                                                    </span>
                                                </div>
                                                {% if georeference.direction is not None %}
                                                <div class="col-auto">
                                                    <span class="badge bg-light text-dark">
                                                        <i class="fas fa-compass me-1"></i>
                                                        {{ georeference.direction }}°
                                                    </span>
                                                </div>
                                                {% endif %}
                                                <div class="col-auto">
                                                    <span class="badge {% if georeference.confidence == 'high' %}bg-success{% elif georeference.confidence == 'medium' %}bg-warning text-dark{% elif georeference.confidence == 'low' %}bg-danger{% else %}bg-secondary{% endif %}">
                                                        {{ georeference.confidence|capfirst }} Confidence
                                                    </span>
                                                </div>
                                                <div class="col-auto">
                                                    <span class="badge {% if georeference.validation_count > 0 %}bg-info{% else %}bg-secondary{% endif %}">
                                                        <i class="fas fa-check-circle me-1"></i>
                                                        {{ georeference.validation_count }} validation{{ georeference.validation_count|pluralize }}
                                                    </span>
                                                </div>
                                            </div>
                                            {% if georeference.confidence_notes %}
                                                <div class="timeline-notes">
                                                    <small class="text-muted">
                                                        <i class="fas fa-sticky-note me-1"></i>
                                                        {{ georeference.confidence_notes }}
                                                    </small>
                                                </div>
                                            {% endif %}
                                        </div>

                                        <!-- Validations for this georeference -->
                                        {% if georeference.validations.exists %}
                                            <div class="timeline-validations mt-3">
                                                <h6 class="small text-muted mb-2">
                                                    <i class="fas fa-users me-1"></i>Community Validations:
                                                </h6>
                                                <div class="validation-list">
                                                    {% for validation in georeference.validations.all %}
                                                        <div class="validation-item d-flex align-items-start mb-2">
                                                            <div class="validation-icon me-2">
                                                                {% if validation.validation == 'correct' %}
                                                                    <i class="fas fa-check text-success"></i>
                                                                {% elif validation.validation == 'incorrect' %}
                                                                    <i class="fas fa-times text-danger"></i>
                                                                {% else %}
                                                                    <i class="fas fa-question text-warning"></i>
                                                                {% endif %}
                                                            </div>
                                                            <div class="validation-content flex-grow-1">
                                                                <div class="d-flex justify-content-between align-items-center">
                                                                    <span class="validation-user">
                                                                        {% if validation.validated_by.get_profile_url %}
                                                                            <strong>
                                                                                <a href="{{ validation.validated_by.get_profile_url }}" target="_blank" class="text-decoration-none text-dark">
                                                                                    {{ validation.validated_by.get_display_name }}
                                                                                    <i class="fas fa-external-link-alt ms-1 small text-muted"></i>
                                                                                </a>
                                                                            </strong>
                                                                        {% else %}
                                                                            <strong>{{ validation.validated_by.get_display_name }}</strong>
                                                                        {% endif %}
                                                                        <span class="badge {% if validation.validation == 'correct' %}bg-success{% elif validation.validation == 'incorrect' %}bg-danger{% else %}bg-warning text-dark{% endif %} ms-1">
                                                                            {{ validation.validation|capfirst }}
                                                                        </span>
                                                                    </span>
                                                                    <small class="text-muted">{{ validation.validated_at|date:"M j, g:i A" }}</small>
                                                                </div>
                                                                {% if validation.notes %}
                                                                    <p class="validation-notes small text-muted mb-0 mt-1">{{ validation.notes }}</p>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Validation Modal -->
{% if image.is_georeferenced and request.user.is_authenticated and image.get_georeference and image.get_georeference.id %}
    {% if not image.get_georeference.georeferenced_by or request.user != image.get_georeference.georeferenced_by %}
<div class="modal fade" id="validateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Validate Georeference</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="validateForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label fw-bold">Is this georeference correct?</label>
                        <div class="mt-2">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="validation" value="correct" id="correct">
                                <label class="form-check-label" for="correct">
                                    <span class="badge bg-success me-2">✓ Correct</span>
                                    I believe it is correct
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="validation" value="uncertain" id="uncertain">
                                <label class="form-check-label" for="uncertain">
                                    <span class="badge bg-warning text-dark me-2">? Uncertain</span>
                                    I'm not sure
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="validation" value="incorrect" id="incorrect">
                                <label class="form-check-label" for="incorrect">
                                    <span class="badge bg-danger me-2">✗ Incorrect</span>
                                    I believe it is incorrect
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="validationNotes" class="form-label">Additional Comments <span class="text-muted">(optional)</span></label>
                        <textarea class="form-control" id="validationNotes" name="notes" rows="3"
                                  placeholder="Any specific feedback about this georeference..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-1"></i>Submit Validation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
    {% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- MapLibre GL JS -->
<script src="https://unpkg.com/maplibre-gl@5.7.1/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/umd/photoswipe.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@5.4.4/dist/umd/photoswipe-lightbox.umd.min.js"></script>

<script>
// Global utility functions
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

function getBootstrapColor(difficulty) {
    const colors = { easy: 'success', medium: 'warning', hard: 'danger' };
    return colors[difficulty] || 'secondary';
}

// PhotoSwipe setup
function setupPhotoSwipeData(img) {
    const link = img.parentElement;
    link.setAttribute('data-pswp-width', img.naturalWidth);
    link.setAttribute('data-pswp-height', img.naturalHeight);
}

const lightbox = new PhotoSwipeLightbox({
    gallery: '#pswp-gallery',
    children: 'a',
    showHideAnimationType: 'fade',
    zoomAnimationDuration: 300,
    maxZoomLevel: 8,
    wheelToZoom: true,
    pswpModule: PhotoSwipe
});
lightbox.init();

document.addEventListener('DOMContentLoaded', function() {
    // Set validation URL if georeference exists
    {% if image.is_georeferenced and image.get_georeference and image.get_georeference.id %}
    const validationUrl = "{% url 'images:validate_georeference' image.get_georeference.id %}";
    {% else %}
    const validationUrl = null;
    {% endif %}
    // Image loading handlers
    const mainImage = document.getElementById('main-image');
    const imageFallback = document.getElementById('image-fallback');

    if (mainImage && imageFallback) {
        mainImage.onload = function() {
            imageFallback.style.setProperty('display', 'none', 'important');
            mainImage.style.display = 'block';
            mainImage.style.visibility = 'visible';
            setupPhotoSwipeData(this);
        };

        mainImage.onerror = function() {
            mainImage.style.display = 'none';
            imageFallback.style.setProperty('display', 'flex', 'important');
        };

        // Handle already loaded images
        if (mainImage.complete) {
            if (mainImage.naturalHeight !== 0 && mainImage.naturalWidth !== 0) {
                imageFallback.style.setProperty('display', 'none', 'important');
                mainImage.style.display = 'block';
                mainImage.style.visibility = 'visible';
                setupPhotoSwipeData(mainImage);
            } else {
                mainImage.style.display = 'none';
                imageFallback.style.setProperty('display', 'flex', 'important');
            }
        }
    }

    // Difficulty marking functionality (admin only)
    const isStaff = {{ user.is_staff|yesno:"true,false" }};

    function handleDifficultyClick() {
        const difficulty = this.dataset.difficulty;
        const clickedButton = this;
        const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]')?.value || '{{ csrf_token }}';

        clickedButton.disabled = true;
        const originalText = clickedButton.innerHTML;
        clickedButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        const formData = new FormData();
        formData.append('difficulty', difficulty);
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch(`{% url 'images:mark_difficulty' image.id %}`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                showAlert('success', `Image marked as ${difficulty}`);
                clickedButton.innerHTML = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
                clickedButton.disabled = false;

                // Force reflow and update UI
                clickedButton.offsetHeight;
                setTimeout(() => {
                    updateDifficultyButtons(difficulty);
                    updateDifficultyBadge(difficulty);
                }, 10);
            } else {
                throw new Error('Network response was not ok');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'Error marking difficulty. Please try again.');
            clickedButton.disabled = false;
            clickedButton.innerHTML = originalText;
        });
    }

    function updateDifficultyButtons(newDifficulty) {
        // Find the difficulty button group
        let buttonGroup = null;
        document.querySelectorAll('.btn-group').forEach(group => {
            const buttons = group.querySelectorAll('button');
            buttons.forEach(btn => {
                const text = btn.textContent.toLowerCase().trim();
                if (btn.hasAttribute('data-difficulty') ||
                    btn.classList.contains('mark-difficulty') ||
                    ['easy', 'medium', 'hard'].some(d => text.includes(d))) {
                    buttonGroup = group;
                }
            });
        });

        if (!buttonGroup) return;

        const buttons = buttonGroup.querySelectorAll('button');
        const labelText = buttonGroup.previousElementSibling;

        // Update label
        if (labelText && labelText.tagName === 'SMALL') {
            labelText.textContent = 'Difficulty Level:';
        }

        buttons.forEach(button => {
            const buttonText = button.textContent.toLowerCase().trim();
            let buttonDifficulty = ['easy', 'medium', 'hard'].find(d => buttonText.includes(d));

            if (buttonDifficulty === newDifficulty) {
                // Selected difficulty: highlight and disable
                button.className = `btn btn-sm btn-${getBootstrapColor(newDifficulty)}`;
                button.disabled = true;
                button.removeAttribute('data-difficulty');
            } else {
                // Other difficulties: make clickable
                button.className = `btn btn-sm btn-outline-${getBootstrapColor(buttonDifficulty)} mark-difficulty`;
                button.disabled = false;
                button.setAttribute('data-difficulty', buttonDifficulty);

                if (!button.hasEventListener) {
                    button.addEventListener('click', handleDifficultyClick);
                    button.hasEventListener = true;
                }
            }
            button.innerHTML = buttonDifficulty.charAt(0).toUpperCase() + buttonDifficulty.slice(1);
        });
    }

    function updateDifficultyBadge(newDifficulty) {
        const cardHeader = document.querySelector('.card-header');
        if (!cardHeader) return;

        let difficultyBadge = cardHeader.querySelector('.badge');

        if (difficultyBadge && difficultyBadge.innerHTML.includes('fa-signal')) {
            // Update existing badge
            difficultyBadge.className = `badge status-badge bg-${getBootstrapColor(newDifficulty)}`;
            difficultyBadge.innerHTML = `<i class="fas fa-signal me-1"></i>${newDifficulty.charAt(0).toUpperCase() + newDifficulty.slice(1)}`;
        } else {
            // Create new badge
            const badgeContainer = cardHeader.querySelector('.d-flex.gap-2');
            if (badgeContainer) {
                const newBadge = document.createElement('span');
                newBadge.className = `badge status-badge bg-${getBootstrapColor(newDifficulty)}`;
                newBadge.innerHTML = `<i class="fas fa-signal me-1"></i>${newDifficulty.charAt(0).toUpperCase() + newDifficulty.slice(1)}`;
                badgeContainer.insertBefore(newBadge, badgeContainer.firstChild);
            }
        }
    }

    // Initialize difficulty buttons
    if (isStaff) {
        document.querySelectorAll('.mark-difficulty').forEach(button => {
            button.addEventListener('click', handleDifficultyClick);
            button.hasEventListener = true;
        });
    }

    // Validation form handler
    const validateForm = document.getElementById('validateForm');
    if (validateForm && validationUrl) {
        validateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(validateForm);
            const validation = formData.get('validation');

            if (!validation) {
                alert('Please select a validation option.');
                return;
            }

            const submitBtn = validateForm.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Submitting...';
            submitBtn.disabled = true;

            fetch(validationUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                },
                body: JSON.stringify({
                    validation: validation,
                    notes: formData.get('notes') || ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while submitting the validation.');
            })
            .finally(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        });
    }

    // Map initialization for georeferenced images
    {% if image.is_georeferenced %}
    const mapContainer = document.getElementById('image-detail-map');
    if (mapContainer) {
        const map = new maplibregl.Map({
            container: 'image-detail-map',
            style: 'https://styles.trailsta.sh/openmaptiles-osm.json',
            center: [{{ image.get_georeference.longitude }}, {{ image.get_georeference.latitude }}],
            zoom: 16
        });

        map.on('load', async function() {
            try {
                const image = await map.loadImage('https://maprva.org/img/surveillance-direction.png');
                map.addImage('surveillance-direction', image.data);
            } catch (error) {
                console.warn('Could not load direction arrow image:', error);
            }

            const imageGeojsonData = {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "geometry": {
                        "type": "Point",
                        "coordinates": [{{ image.get_georeference.longitude }}, {{ image.get_georeference.latitude }}]
                    },
                    "properties": {
                        "img_url": "{{ image.permalink }}",
                        "img_entry": "{{ request.build_absolute_uri }}",
                        {% if image.get_georeference.direction is not None %}
                        "direction": {{ image.get_georeference.direction }},
                        {% endif %}
                        {% if image.year %}
                        "year": "{{ image.year }}"
                        {% endif %}
                    }
                }]
            };

            map.addSource('image-location', {
                'type': 'geojson',
                'data': imageGeojsonData
            });

            // Add direction markers
            if (map.hasImage('surveillance-direction')) {
                map.addLayer({
                    'id': 'image-directions',
                    'type': 'symbol',
                    'source': 'image-location',
                    'layout': {
                        'icon-image': 'surveillance-direction',
                        'icon-overlap': 'always',
                        'icon-size': {'stops': [[5, 0.3], [15, 1]]},
                        'icon-rotate': ['to-number', ['get', 'direction']]
                    },
                    'filter': ['has', 'direction']
                });
            }

            // Add location marker
            map.addLayer({
                'id': 'image-circles',
                'type': 'circle',
                'source': 'image-location',
                'paint': {
                    'circle-radius': 8,
                    'circle-color': '#dc3545',
                    'circle-stroke-color': '#fff',
                    'circle-stroke-width': 2
                }
            });

            // Add popup on click
            map.on('click', 'image-circles', function(e) {
                const properties = e.features[0].properties;
                const popupContent = `
                    <div style="max-width: 200px;">
                        <img src="${properties.img_url}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display: none; text-align: center; padding: 20px; background: #f8f9fa; border-radius: 4px;">
                            <i class="fas fa-image" style="font-size: 2em; color: #6c757d; margin-bottom: 8px;"></i>
                            <p style="margin: 0; color: #6c757d; font-size: 0.9em;">Image not available</p>
                        </div>
                        ${properties.year ? `<p style="margin: 4px 0; font-size: 0.9em; color: #666;">Year: ${properties.year}</p>` : ''}
                        ${properties.direction ? `<p style="margin: 4px 0; font-size: 0.9em; color: #666;">Direction: ${properties.direction}°</p>` : ''}
                    </div>
                `;

                new maplibregl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(popupContent)
                    .addTo(map);
            });

            // Mouse events
            map.on('mouseenter', 'image-circles', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'image-circles', () => map.getCanvas().style.cursor = '');
        });
    }
    {% endif %}
});
</script>
{% endblock %}
